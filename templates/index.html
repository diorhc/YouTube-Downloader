<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Download videos from popular platforms across the web with ease">
    <meta name="theme-color" content="#4fc3f7">
    <link rel="icon" href="img/by.svg" type="image/svg+xml">
    <link rel="icon" href="img/by.png" sizes="32x32" type="image/png">
    <link rel="shortcut icon" href="img/by.png">
    <link rel="apple-touch-icon" href="img/by.png">
    <meta name="msapplication-TileImage" content="img/by.png">
    <title>Youtube Downloader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --fg: #ffffff;
            --input-bg: #1a1a1a;
            --input-fg: #ffffff;
            --input-placeholder: #a0a0a0;
            --accent: #00d4ff;
            --accent-hover: #00b8e6;
            --error: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --shadow2: 0 2px 12px rgba(0, 0, 0, 0.3);
            --progress-bg: #2a2a2a;
            --progress-fill: #00d4ff;
            --secondary: #a0a0a0;
            --border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(26, 26, 26, 0.7);
        }

        body.light {
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --fg: #2c3e50;
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-fg: #2c3e50;
            --input-placeholder: #7f8c8d;
            --accent: #3498db;
            --accent-hover: #2980b9;
            --error: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            --shadow2: 0 2px 12px rgba(0, 0, 0, 0.1);
            --progress-bg: #ecf0f1;
            --progress-fill: #3498db;
            --secondary: #7f8c8d;
            --border: rgba(255, 255, 255, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.8);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--fg);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            opacity: 0.1;
            z-index: -1;
        }

        body.light::before {
            opacity: 0.3;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .center-content {
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        .logo {
            position: fixed;
            top: 24px;
            left: 32px;
            z-index: 10;
            width: 32px;
            height: 32px;
            color: var(--f);
        }

        .app-title {
            position: fixed;
            top: 32px;
            left: 88px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--fg);
            z-index: 10;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle {
            position: fixed;
            top: 24px;
            right: 88px;
            z-index: 10;
            background: var(--glass-bg);
            color: var(--fg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow2);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--glass-bg);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 0 24px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
            position: relative;
        }

        .search-bar:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .search-bar input[type="url"] {
            flex: 1;
            background: none;
            border: none;
            color: var(--input-fg);
            font-size: 1.1rem;
            padding: 20px 0;
            outline: none;
            font-family: inherit;
        }

        .search-bar input[type="url"]::placeholder {
            color: var(--input-placeholder);
        }

        .search-bar button {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 8px;
            margin-left: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .search-bar button:hover {
            color: var(--accent);
            transform: translateX(4px);
        }

        .options {
            position: fixed;
            display: flex;
            flex-wrap: nowrap;
            bottom: 24px;
            align-items: center;
            padding: 8px;
            width: 75px;
            height: 75px;
            z-index: 10;
        }

        .options-bar {
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            color: var(--secondary);
            font-size: 0.95rem;
            flex-wrap: wrap;
        }

        .options-bar label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .options-bar input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .option-warning {
            color: var(--warning);
            font-size: 0.85rem;
        }

        .download-btn {
            position: fixed;
            top: 24px;
            right: 32px;
            background: var(--glass-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            width: 44px;
            height: 44px;
            backdrop-filter: blur(20px);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        #videoInfoContainer {
            width: 100%;
            margin: 18px 0 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 24px 18px;
            display: none;
            transition: all 0.3s ease;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 16px;
            align-items: center;
        }

        .video-thumbnail {
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: var(--shadow2);
        }

        .video-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .video-title {
            color: var(--fg);
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: text;
            grid-column: 1 / -1;
            padding: 8px 12px;
            min-height: 2.5rem;
            line-height: 1.4;
            text-align: center;
        }

        .video-title:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
        }

        .video-title:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .video-meta {
            color: var(--secondary);
            font-size: 0.95rem;
        }

        .quality-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        .quality-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
        }

        .quality-link:hover {
            color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .quality-link.audio-only {
            color: var(--warning);
        }

        #downloadProgressBar {
            position: fixed;
            top: 75px;
            right: 32px;
            width: 100%;
            max-width: 480px;
            background: var(--glass-bg);
            backdrop-filter: blur(18px);
            border-radius: 16px;
            box-shadow: var(--shadow2);
            padding: 16px;
            display: none;
            border: 1px solid var(--border);
            z-index: 999;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }

        .progress-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .progress-details {
            flex: 1;
        }

        .progress-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--fg);
            margin-bottom: 4px;
        }

        .progress-bar-bg {
            width: 100%;
            background: var(--progress-bg);
            border-radius: 6px;
            height: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--progress-fill);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            color: var(--fg);
            font-weight: 500;
            max-width: 350px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error), #e74c3c);
            color: white;
        }

        .notification.info {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(255, 165, 2, 0.2), rgba(255, 165, 2, 0.35));
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(18px);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--secondary);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-bg);
            border-radius: var(--border-radius);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .center-content {
                max-width: 95%;
                padding: 0 16px;
            }

            .logo {
                left: 16px;
            }

            .app-title {
                left: 64px;
                font-size: 1.2rem;
            }

            .theme-toggle {
                right: 72px;
            }

            .download-btn {
                right: 16px;
            }

            .video-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .search-bar {
                padding: 0 16px;
            }

            .search-bar input[type="url"] {
                font-size: 1rem;
                padding: 16px 0;
            }

            #downloadProgressBar {
                right: 16px;
                max-width: calc(100% - 32px);
            }
        }

        @media (max-width: 480px) {
            .app-title {
                display: none;
            }

            .theme-toggle {
                right: 72px;
            }
        }
    </style>
</head>

<body>
    <!-- Glass SVG defs (hidden) -->
    <svg aria-hidden="true" focusable="false" style="position: absolute; width: 0; height: 0; overflow: hidden;"
        id="uvd-glass-defs">
        <defs>
            <!-- Dark theme glass gradient -->
            <linearGradient id="uvd-glassGradient-dark" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.14" />
                <stop offset="50%" stop-color="#ffffff" stop-opacity="0.09" />
                <stop offset="100%" stop-color="#ffffff" stop-opacity="0.04" />
            </linearGradient>

            <!-- Light theme glass gradient (slightly stronger) -->
            <linearGradient id="uvd-glassGradient-light" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.28" />
                <stop offset="50%" stop-color="#ffffff" stop-opacity="0.18" />
                <stop offset="100%" stop-color="#ffffff" stop-opacity="0.08" />
            </linearGradient>

            <filter id="uvd-glassBlur" x="-25%" y="-25%" width="150%" height="150%" primitiveUnits="objectBoundingBox">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blurred" />
                <feFlood flood-color="rgba(255,255,255,0.12)" result="flood" />
                <feComposite in="flood" in2="blurred" operator="in" result="floodOnBlur" />
                <feBlend in="SourceGraphic" in2="floodOnBlur" mode="screen" />
            </filter>

            <!-- Dark and light edge gloss variants -->
            <linearGradient id="uvd-glassEdge-dark" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.18" />
                <stop offset="100%" stop-color="#ffffff" stop-opacity="0" />
            </linearGradient>

            <linearGradient id="uvd-glassEdge-light" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.28" />
                <stop offset="100%" stop-color="#ffffff" stop-opacity="0" />
            </linearGradient>
        </defs>
    </svg>

    <div class="logo">
        <svg class="app-icon" width="48" height="48" xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg" version="1.1">
            <path
                d="m23.24,4.62c-0.85,0.45 -2.19,2.12 -4.12,5.13c-1.54,2.41 -2.71,4.49 -3.81,6.8c-0.55,1.14 -1.05,2.2 -1.13,2.35c-0.08,0.16 -0.78,0.7 -1.66,1.28c-1.38,0.91 -1.8,1.29 -1.4,1.28c0.08,0 0.67,-0.35 1.31,-0.77c0.64,-0.42 1.19,-0.76 1.2,-0.74c0.02,0.02 -0.1,0.31 -0.25,0.66c-1.03,2.25 -1.84,5.05 -1.84,6.37c0.01,1.89 0.84,2.67 2.86,2.67c1.08,0 1.94,-0.31 3.66,-1.29c1.84,-1.06 3.03,-1.93 4.18,-3.09c1.69,-1.7 2.91,-3.4 3.28,-4.59c0.59,-1.9 -0.1,-3.08 -2.02,-3.44c-0.87,-0.16 -2.85,-0.14 -3.75,0.06c-1.78,0.38 -2.74,0.76 -2.5,1c0.03,0.03 0.5,-0.1 1.05,-0.28c1.49,-0.48 2.34,-0.59 3.88,-0.53c1.64,0.07 2.09,0.19 2.69,0.75l0.46,0.43l0,0.87c0,0.74 -0.05,0.98 -0.35,1.6c-0.69,1.45 -2.69,3.81 -4.37,5.14c-0.93,0.74 -2.88,1.94 -4.07,2.5c-1.64,0.77 -3.56,0.72 -4.21,-0.11c-0.39,-0.5 -0.5,-1.02 -0.44,-2.11c0.05,-0.85 0.16,-1.32 0.67,-2.86c0.34,-1.01 0.86,-2.38 1.15,-3.04c0.52,-1.18 0.55,-1.22 1.6,-2.14c4.19,-3.65 8.42,-9.4 9.02,-12.26c0.2,-0.94 0.13,-1.46 -0.21,-1.7c-0.31,-0.22 -0.38,-0.21 -0.89,0.06m0.19,0.26c-0.92,0.41 -3.15,3.44 -5.59,7.6c-1.05,1.79 -3.12,5.85 -3.02,5.95c0.07,0.07 1.63,-1.33 2.58,-2.34c1.57,-1.65 3.73,-4.39 4.88,-6.17c1.31,-2.03 2.06,-4.11 1.77,-4.89c-0.13,-0.34 -0.16,-0.35 -0.62,-0.15m11.69,13.32c-0.3,0.6 -1.19,2.54 -1.98,4.32c-1.6,3.62 -1.67,3.71 -2.99,4.34c-1.13,0.54 -2.31,0.85 -3.54,0.92c-0.99,0.06 -1.08,0.04 -1.38,-0.19c-0.28,-0.22 -0.31,-0.31 -0.26,-0.7c0.03,-0.25 0.64,-1.63 1.35,-3.08c1.16,-2.36 2.52,-5.61 2.52,-6.01c0,-0.49 -0.36,0.19 -1.17,2.22c-0.51,1.26 -1.37,3.16 -1.93,4.24c-0.55,1.08 -1.04,2.17 -1.09,2.43c-0.1,0.59 0.07,1.03 0.49,1.28c0.78,0.46 3.3,0.06 5.13,-0.81l0.93,-0.45l-0.66,1.25c-0.7,1.33 -3.36,6.07 -4.31,7.67c-2.02,3.41 -3.96,5.32 -6.33,6.21c-2.57,0.96 -4.92,0.74 -6.14,-0.58c-0.81,-0.88 -0.82,-1.71 -0.04,-3.22c1.22,-2.36 6.52,-6.15 10.48,-7.49c0.52,-0.18 0.95,-0.39 0.95,-0.46c0,-0.21 -0.19,-0.18 -1.24,0.2c-1.19,0.43 -3.12,1.37 -4.34,2.11c-2.61,1.59 -5.44,4.09 -6.13,5.43c-1.15,2.2 -0.73,3.61 1.4,4.6c0.59,0.28 0.75,0.3 2.04,0.3c1.67,0 2.42,-0.18 3.88,-0.89c1.87,-0.92 3.17,-2.13 4.72,-4.41c0.98,-1.44 4.66,-7.88 5.91,-10.33c0.25,-0.49 0.68,-1.19 0.96,-1.56c0.28,-0.37 0.76,-1.15 1.06,-1.73c0.82,-1.59 2.58,-6.1 2.58,-6.6c0,-0.06 -0.07,-0.1 -0.17,-0.1c-0.1,0 -0.39,0.44 -0.71,1.09m-1.34,3.7c-0.93,2.08 -1.09,2.48 -0.87,2.2c0.19,-0.24 1.66,-3.65 1.6,-3.71c-0.02,-0.02 -0.35,0.66 -0.73,1.51"
                fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="1.5" />
        </svg>
    </div>

    <div class="app-title">Youtube Downloader</div>

    <button class="theme-toggle" id="themeToggle">
        <svg id="themeIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="5" stroke-width="1.5" />
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="1.5" />
        </svg>
    </button>

    <div class="download-btn" id="downloadBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </div>

    <div class="center-content">
        <form class="search-bar" id="searchForm">
            <input type="url" id="urlInput" autocomplete="off" placeholder="Enter video URL (VK, Yandex, Dzen...)"
                required>
            <button type="button" id="pasteBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
            <button type="submit" id="getInfoBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M9 5L14.15 10C14.4237 10.2563 14.6419 10.5659 14.791 10.9099C14.9402 11.2539 15.0171 11.625 15.0171 12C15.0171 12.375 14.9402 12.7458 14.791 13.0898C14.6419 13.4339 14.4237 13.7437 14.15 14L9 19"
                        stroke-width="2"></path>
                </svg>
            </button>
        </form>

        <div id="videoInfoContainer"></div>
    </div>

    <div class="options">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M23.405 16.865C22.8611 15.7695 22.1444 14.7688 21.2825 13.9013C20.9892 13.5603 20.6453 13.2238 20.3768 12.9612L20.3393 12.9245C20.2008 12.7889 20.0864 12.6764 19.9928 12.5795C21.1713 10.9407 22.18 9.18595 23.003 7.34222L23.0362 7.26783L23.0595 7.18976C23.1676 6.82687 23.2922 6.1368 22.8515 5.51317C22.396 4.86859 21.6666 4.75234 21.1782 4.75234H18.9311C18.4627 4.73087 17.9988 4.85751 17.6058 5.11498C17.2098 5.37439 16.9069 5.75278 16.7402 6.1951C16.2563 7.34779 15.6508 8.4442 14.9347 9.46598V6.83269C14.9347 6.4923 14.9027 5.92289 14.5382 5.44229C14.1018 4.86685 13.4707 4.75234 13.0326 4.75234H9.46708C9.00771 4.74172 8.56094 4.90597 8.2176 5.21259C7.866 5.52659 7.65052 5.96521 7.61687 6.43543L7.61369 6.47997V6.52463C7.61369 7.01011 7.80606 7.36822 7.95975 7.59344C8.02856 7.69427 8.10216 7.78606 8.14865 7.84403L8.15938 7.85741C8.20895 7.91923 8.24204 7.96049 8.27525 8.00566C8.3626 8.12448 8.48824 8.30768 8.52379 8.78174V10.2547C7.9091 9.24423 7.26066 7.89957 6.77276 6.46344L6.76527 6.4414L6.75697 6.41965C6.63532 6.10103 6.4402 5.63743 6.04941 5.28266C5.59288 4.86821 5.0529 4.75234 4.56182 4.75234H2.28187C1.78506 4.75234 1.18613 4.86857 0.739237 5.33999C0.299773 5.80358 0.25 6.35907 0.25 6.65442V6.78755L0.278039 6.91769C0.909544 9.84881 2.21076 12.5937 4.07946 14.9377C4.92668 16.2737 6.07468 17.3936 7.43213 18.2075C8.81124 19.0345 10.3671 19.5219 11.9715 19.6297L12.0133 19.6325H12.0553C12.7811 19.6325 13.5378 19.5699 14.1068 19.1907C14.8744 18.6792 14.9347 17.8936 14.9347 17.5021V16.3642C15.1317 16.5234 15.3761 16.7378 15.6753 17.0259C16.037 17.3879 16.325 17.7016 16.572 17.9754L16.7038 18.122L16.7046 18.1228C16.8964 18.3364 17.0852 18.5467 17.2571 18.7195C17.4732 18.9367 17.7396 19.1761 18.0745 19.3529C18.4371 19.5444 18.8177 19.631 19.222 19.631H21.5035C21.9841 19.631 22.6735 19.5173 23.1582 18.9554C23.6864 18.343 23.6461 17.5924 23.48 17.053L23.4501 16.956L23.405 16.865ZM17.6857 16.9706C17.4289 16.6859 17.1192 16.3484 16.7278 15.9571L16.7246 15.9539C15.3685 14.6464 14.7348 14.4186 14.2868 14.4186C14.0485 14.4186 13.7848 14.4454 13.6137 14.6585C13.5329 14.7591 13.4905 14.8805 13.4667 15.007C13.4429 15.1333 13.4347 15.2816 13.4347 15.4505V17.5021C13.4347 17.7569 13.3928 17.8639 13.275 17.9425C13.118 18.0471 12.7825 18.1319 12.0637 18.1325C10.6993 18.0395 9.37641 17.6244 8.20349 16.9211C7.02817 16.2164 6.03709 15.2425 5.31187 14.0797L5.30398 14.0671L5.29464 14.0554C3.55337 11.8881 2.34003 9.34571 1.7503 6.6291C1.7535 6.49814 1.78187 6.42045 1.82784 6.37195C1.87521 6.32198 1.98999 6.25234 2.28187 6.25234H4.56182C4.81544 6.25234 4.9467 6.30751 5.04117 6.39327C5.14827 6.4905 5.24116 6.65561 5.35401 6.95042C5.91362 8.5964 6.67038 10.1357 7.387 11.2675C7.74518 11.8332 8.09769 12.3041 8.41529 12.6368C8.57383 12.803 8.72932 12.9406 8.8777 13.0385C9.02132 13.1332 9.18414 13.2079 9.35158 13.2079C9.43994 13.2079 9.54328 13.1988 9.64279 13.1547C9.74983 13.1074 9.83291 13.0284 9.89158 12.9225C9.99536 12.7353 10.0238 12.458 10.0238 12.0947V8.73099L10.0233 8.7231C9.97146 7.90476 9.72439 7.44443 9.48381 7.11718C9.43108 7.04546 9.37909 6.98068 9.33359 6.92399L9.32113 6.90846C9.27117 6.84616 9.23142 6.79582 9.19876 6.74795C9.13891 6.66024 9.11571 6.59909 9.11381 6.53356C9.12162 6.45578 9.15828 6.38361 9.21675 6.33139C9.27744 6.27719 9.35686 6.24897 9.43816 6.25234H13.0326C13.2387 6.25234 13.3081 6.30262 13.343 6.34868C13.3923 6.4137 13.4347 6.54893 13.4347 6.83269V11.3613C13.4347 11.8992 13.6827 12.2634 14.0428 12.2634C14.4572 12.2634 14.7559 12.012 15.2783 11.4896L15.287 11.4809L15.2948 11.4713C16.4656 10.0436 17.4225 8.45298 18.1347 6.74943L18.1392 6.73666C18.1928 6.58613 18.2941 6.45726 18.4278 6.3697C18.5614 6.28215 18.72 6.24072 18.8794 6.25175L18.8881 6.25234H21.1782C21.4905 6.25234 21.5933 6.33183 21.6265 6.37884C21.6618 6.42885 21.6864 6.53604 21.6264 6.74625C20.8053 8.58266 19.7899 10.3258 18.598 11.9464L18.5905 11.9578C18.4748 12.1348 18.3479 12.3306 18.3295 12.5554C18.3098 12.7968 18.4143 13.0163 18.597 13.2515C18.7302 13.4484 19.0049 13.7173 19.2836 13.9901L19.3099 14.0158C19.6021 14.3018 19.9186 14.6116 20.1727 14.9116L20.1795 14.9195L20.1869 14.9269C20.9444 15.6825 21.5743 16.556 22.052 17.5132C22.1283 17.7738 22.0816 17.907 22.0223 17.9757C21.953 18.0561 21.7976 18.131 21.5035 18.131H19.222C19.0438 18.131 18.9063 18.0959 18.7749 18.0265C18.638 17.9542 18.4972 17.8392 18.3206 17.6617C18.1784 17.5187 18.023 17.3457 17.8334 17.1348C17.7864 17.0825 17.7373 17.0277 17.6857 16.9706Z"
                    fill="none" data-darkreader-inline-fill="" stroke="currentColor"
                    style="--darkreader-inline-fill: var(--darkreader-background-000000, #181a1b);"></path>
            </g>
        </svg>
        <svg viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="none" data-darkreader-inline-fill=""
            style="--darkreader-inline-fill: var(--darkreader-background-000000, #181a1b);">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <path fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"
                    d="M120.675 42.01h-12.121c-22.222 0-33.91 10.69-33.91 26.45 0 17.818 8.08 26.163 24.675 36.866l13.708 8.772L73.634 170H44.197l35.353-50.01c-20.334-13.842-31.746-27.285-31.746-50.022C47.804 41.46 68.728 22 108.41 22h39.394v147.863h-27.128z"
                    data-name="Контур 2"
                    style="stroke-width: 12; stroke-miterlimit: 4; stroke-dasharray: none; --darkreader-inline-stroke: var(--darkreader-text-000000, #e8e6e3);"
                    data-darkreader-inline-stroke=""></path>
            </g>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width=""
            data-darkreader-inline-fill=""
            style="--darkreader-inline-fill: var(--darkreader-background-000000, #181a1b);">
            <g id="_Слой_1-2" data-name="Слой 1">
                <path class="cls-1"
                    d="M24.72,0c.12,9.73.79,15.2,4.44,18.84,3.65,3.65,9.12,4.31,18.85,4.44C47.63,10.59,37.41.37,24.72,0Z" />
                <path class="cls-1"
                    d="M18.85,18.84C22.5,15.2,23.16,9.73,23.28,0,10.59.37.37,10.59,0,23.28c9.73-.12,15.2-.79,18.85-4.44Z" />
                <path class="cls-1"
                    d="M0,24.72c.37,12.69,10.59,22.91,23.28,23.28-.12-9.73-.79-15.2-4.44-18.84-3.65-3.65-9.12-4.31-18.85-4.44Z" />
                <path class="cls-1"
                    d="M48,24.72c-9.73.12-15.2.79-18.85,4.44-3.65,3.65-4.31,9.12-4.44,18.84,12.69-.37,22.91-10.59,23.28-23.28Z" />
                <path class="cls-2"
                    d="M48,24c0,.24,0,.48-.01.72-9.72.12-15.19.79-18.83,4.44-3.65,3.65-4.31,9.11-4.44,18.83-.24,0-.48.01-.72.01s-.48,0-.72-.01c-.12-9.72-.79-15.19-4.44-18.83C15.2,25.51,9.73,24.84.01,24.72c0-.24-.01-.48-.01-.72s0-.48.01-.72c9.72-.12,15.19-.79,18.83-4.44C22.49,15.2,23.16,9.73,23.28.01c.24,0,.48-.01.72-.01s.48,0,.72.01c.12,9.72.79,15.19,4.44,18.83,3.65,3.65,9.11,4.31,18.83,4.44,0,.24.01.48.01.72Z" />
            </g>
        </svg>
    </div>

    <div id="downloadProgressBar">
        <div class="progress-container">
            <div class="progress-thumb" id="progressThumb"></div>
            <div class="progress-details">
                <div class="progress-title" id="progressTitle">Downloading...</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Download History</h2>
                <button type="button" id="clearHistoryBtn"
                    style="background: var(--error); color: white; border: none; border-radius: 8px; padding: 6px 14px; font-size: 0.95rem; cursor: pointer;">Clear</button>
            </div>
            <div id="historyContent"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDownloadId = null;
        let currentVideoTitle = '';
        let currentDownloadThumbnail = '';
        let currentEventSource = null;
        let currentDownloadQuality = null;
        let currentAudioOnly = false;
        let currentVideoUrl = '';
        let currentAvailableAudioLanguages = [];  // Store available audio languages

        // DOM elements
        const urlInput = document.getElementById('urlInput');
        const getInfoBtn = document.getElementById('getInfoBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const videoInfoContainer = document.getElementById('videoInfoContainer');
        const progressBar = document.getElementById('downloadProgressBar');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressTitle = document.getElementById('progressTitle');
        const progressThumb = document.getElementById('progressThumb');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const downloadBtn = document.getElementById('downloadBtn');
        const historyModal = document.getElementById('historyModal');
        const SSL_STORAGE_KEY = 'uvd:insecureSslAllowed';
        const insecureSslToggle = document.getElementById('insecureSslToggle');
        const sslWarning = document.getElementById('sslWarning');

        if (insecureSslToggle) {
            const saved = localStorage.getItem(SSL_STORAGE_KEY);
            if (saved === '1') {
                insecureSslToggle.checked = true;
                if (sslWarning) {
                    sslWarning.style.display = 'inline';
                }
            }

            insecureSslToggle.addEventListener('change', () => {
                const enabled = insecureSslToggle.checked;
                if (sslWarning) {
                    sslWarning.style.display = enabled ? 'inline' : 'none';
                }
                localStorage.setItem(SSL_STORAGE_KEY, enabled ? '1' : '0');
                if (enabled) {
                    showNotification('Insecure SSL enabled. Certificates will not be validated.', 'warning', 5000);
                }
            });
        }

        function escapeHtml(str) {
            return (str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeUrl(value) {
            if (!value) return '';
            const trimmed = value.trim();
            if (/^https?:\/\//i.test(trimmed)) {
                return trimmed;
            }
            return `https://${trimmed}`;
        }

        function isValidUrl(value) {
            if (!value) return false;
            let candidate = value;
            if (!/^https?:\/\//i.test(candidate)) {
                candidate = `https://${candidate}`;
            }
            try {
                const urlObj = new URL(candidate);
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch (err) {
                return false;
            }
        }

        // Theme management
        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light');
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5" stroke-width="1.5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="1.5"/>';
            } else {
                document.body.classList.remove('light');
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5" stroke-width="1.5"/><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="1.5"/>';
            }
        }

        function toggleTheme() {
            const current = document.body.classList.contains('light') ? 'light' : 'dark';
            const next = current === 'light' ? 'dark' : 'light';
            setTheme(next);
            localStorage.setItem('theme', next);
            showNotification(`Switched to ${next} mode`, 'info', 2000);
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') ||
            (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
        setTheme(savedTheme);

        // Paste functionality
        pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text?.trim()) {
                    const normalized = normalizeUrl(text);
                    urlInput.value = normalized;
                    urlInput.focus();
                    showNotification('URL pasted from clipboard', 'success', 2000);

                    if (isValidUrl(normalized)) {
                        setTimeout(() => fetchVideoInfo(), 500);
                    }
                } else {
                    showNotification('No text found in clipboard', 'error', 3000);
                }
            } catch (err) {
                showNotification('Could not access clipboard', 'error', 3000);
            }
        });

        // Form submission
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            fetchVideoInfo();
        });

        // Fetch video info
        async function fetchVideoInfo() {
            const rawUrl = urlInput.value.trim();
            if (!rawUrl) {
                showNotification('Please enter a video URL', 'error');
                return;
            }

            const normalizedUrl = normalizeUrl(rawUrl);
            if (!isValidUrl(normalizedUrl)) {
                showNotification('Please enter a valid video URL', 'error');
                return;
            }

            urlInput.value = normalizedUrl;
            const url = normalizedUrl;
            const insecureSslEnabled = insecureSslToggle ? insecureSslToggle.checked : false;

            getInfoBtn.disabled = true;
            getInfoBtn.innerHTML = '<div class="loading"></div>';
            videoInfoContainer.style.display = 'none';

            try {
                const response = await fetch('/api/video_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, insecure_ssl: insecureSslEnabled })
                });

                const data = await response.json();

                if (response.ok && !data.error) {
                    showVideoInfo(data, url);
                    currentVideoTitle = data.title || '';
                    showNotification('Video information loaded successfully!', 'success', 3000);
                } else {
                    const errorMsg = data.error || 'Failed to get video info';
                    showNotification(errorMsg, 'error');
                }
            } catch (err) {
                showNotification(`Network error: ${err.message}`, 'error');
            } finally {
                getInfoBtn.disabled = false;
                getInfoBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5L14.15 10C14.4237 10.2563 14.6419 10.5659 14.791 10.9099C14.9402 11.2539 15.0171 11.625 15.0171 12C15.0171 12.375 14.9402 12.7458 14.791 13.0898C14.6419 13.4339 14.4237 13.7437 14.15 14L9 19" stroke-width="2"></path></svg>';
            }
        }

        // Show video info
        function showVideoInfo(data, url) {
            // Store available audio languages
            currentAvailableAudioLanguages = data.available_audio_languages || [];

            const qualities = Array.isArray(data.available_qualities) && data.available_qualities.length
                ? data.available_qualities.map(q =>
                    `<button class="quality-link" onclick="handleQualitySelection('${q}', '${url}', false)">${q}</button>`
                ).join(' ')
                : '';

            const audioBtn = `<button class="quality-link audio-only" onclick="handleQualitySelection('best', '${url}', true)">Audio Only</button>`;

            videoInfoContainer.innerHTML = `
                <div class="video-grid">
                    <div>
                        ${data.thumbnail ? `<img src="${data.thumbnail}" alt="Video thumbnail" class="video-thumbnail" onclick="window.open('${data.thumbnail}', '_blank')">` : ''}
                    </div>
                    <div class="video-info">                        
                        <div class="video-meta">Duration: ${data.duration || 'Unknown'}</div>
                        <div class="quality-links">
                            ${qualities}
                            ${audioBtn}
                        </div>
                    </div>
                    <div class="video-title" contenteditable="true" oninput="updateVideoTitle(this.innerText)">${data.title || 'Untitled Video'}</div>
                </div>
            `;

            videoInfoContainer.style.display = 'block';
            videoInfoContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Handle quality selection - check if audio track selection is needed
        function handleQualitySelection(quality, url, audioOnly) {
            // If there are multiple audio languages available, show selection dialog
            if (currentAvailableAudioLanguages && currentAvailableAudioLanguages.length > 1 && !audioOnly) {
                showAudioLanguageSelection(quality, url, audioOnly);
            } else {
                // No multiple audio tracks, proceed with download
                startDownload(quality, url, audioOnly, null);
            }
        }

        // Show audio language selection dialog
        function showAudioLanguageSelection(quality, url, audioOnly) {
            const audioOptions = currentAvailableAudioLanguages.map(lang =>
                `<button class="quality-link" onclick="startDownload('${quality}', '${url}', ${audioOnly}, '${lang.code}')" style="margin: 5px;">
                    ${lang.name} (${lang.code})
                </button>`
            ).join('');

            const skipBtn = `<button class="quality-link audio-only" onclick="startDownload('${quality}', '${url}', ${audioOnly}, null)" style="margin: 5px;">
                Default Audio
            </button>`;

            // Create a modal or insert below video info
            const audioSelectionHtml = `
                <div style="margin-top: 20px; padding: 20px; background: var(--input-bg); border-radius: 16px; box-shadow: var(--shadow);">
                    <h3 style="margin: 0 0 15px 0; color: var(--accent);">Select Audio Track</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${skipBtn}
                        ${audioOptions}
                    </div>
                </div>
            `;

            // Append to video info container
            const container = document.getElementById('videoInfoContainer');
            const existingSelection = container.querySelector('.audio-selection-container');
            if (existingSelection) {
                existingSelection.remove();
            }

            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'audio-selection-container';
            selectionDiv.innerHTML = audioSelectionHtml;
            container.appendChild(selectionDiv);

            selectionDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Update video title
        function updateVideoTitle(newTitle) {
            currentVideoTitle = newTitle;
        }

        // Start download
        async function startDownload(quality, url, audioOnly = false, audioLanguage = null) {
            if (!url) return;

            try {
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }

                const thumbnail = document.querySelector('#videoInfoContainer img')?.src || '';
                const title = currentVideoTitle || 'Downloading...';
                currentDownloadThumbnail = thumbnail;
                currentDownloadQuality = audioOnly ? 'Audio Only' : quality;
                currentAudioOnly = audioOnly;
                currentVideoUrl = url;

                showProgressBar(0, 'Initializing download...', thumbnail, title);

                const insecureSslEnabled = insecureSslToggle ? insecureSslToggle.checked : false;
                const downloadMsg = audioLanguage
                    ? `Starting ${audioOnly ? 'audio' : 'video'} download with ${audioLanguage} audio${insecureSslEnabled ? ' (SSL checks disabled)' : ''}...`
                    : `Starting ${audioOnly ? 'audio' : 'video'} download${insecureSslEnabled ? ' (SSL checks disabled)' : ''}...`;
                showNotification(downloadMsg, 'info', 3000);

                const requestBody = {
                    url,
                    quality,
                    audio_only: audioOnly,
                    output_name: title || undefined
                };

                // Add audio language if specified
                if (audioLanguage) {
                    requestBody.audio_language = audioLanguage;
                }

                if (insecureSslEnabled) {
                    requestBody.insecure_ssl = true;
                }

                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (!response.ok || !data.download_id) {
                    const errorMsg = data.error || response.statusText;
                    showNotification(`Download failed: ${errorMsg}`, 'error');
                    hideProgressBar();
                    return;
                }

                currentDownloadId = data.download_id;
                // Save the download URL and filename for this download
                currentDownloadUrl = `/api/download/${currentDownloadId}/file`;
                currentDownloadFilename = data.filename || title;
                startProgressTracking(data.download_id);

            } catch (err) {
                showNotification(`Download error: ${err.message}`, 'error');
                hideProgressBar();
            }
        }

        // Progress tracking
        function startProgressTracking(downloadId) {
            const evtSource = new EventSource(`/api/progress_sse/${downloadId}`);
            currentEventSource = evtSource;

            evtSource.onmessage = function (event) {
                try {
                    const progress = JSON.parse(event.data);
                    let percent = Math.round(progress.progress || 0);
                    let text = '';

                    if (progress.status === 'downloading') {
                        text = `Downloading... ${percent}%`;
                    } else if (progress.status === 'processing') {
                        text = `Processing... ${percent}%`;
                    } else if (progress.status === 'completed') {
                        text = 'Download completed!';
                        percent = 100;
                        showNotification('Download completed successfully!', 'success');
                        handleCompletion(progress);
                        evtSource.close();
                    } else if (progress.status === 'error') {
                        text = `Error: ${progress.error || 'Download failed'}`;
                        showNotification(progress.error || 'Download failed', 'error');
                        evtSource.close();
                        setTimeout(hideProgressBar, 3000);
                    }

                    showProgressBar(percent, text, currentDownloadThumbnail, currentVideoTitle);
                } catch (e) {
                    console.error('Error parsing progress:', e);
                    showNotification('Error processing download progress', 'error');
                }
            };

            evtSource.onerror = function () {
                showNotification('Connection to server lost', 'error');
                evtSource.close();
            };
        }

        // Handle completion
        function handleCompletion(progress) {
            const finishedFilename = progress.filename;
            const resolvedDownloadId = progress.download_id || currentDownloadId || '';
            const resolvedDownloadUrl = resolvedDownloadId ? `/api/download/${resolvedDownloadId}/file` : (currentDownloadUrl || '');

            if (finishedFilename && resolvedDownloadId) {
                // Add to history
                const downloadInfo = {
                    downloadId: resolvedDownloadId,
                    filename: finishedFilename,
                    title: currentVideoTitle || finishedFilename,
                    thumbnail: currentDownloadThumbnail || '',
                    downloadQuality: currentDownloadQuality || (currentAudioOnly ? 'Audio Only' : 'unknown'),
                    audioOnly: currentAudioOnly,
                    downloadUrl: resolvedDownloadUrl,
                    originalUrl: currentVideoUrl,
                    filePath: progress.file_path || '',
                    timestamp: new Date().toISOString()
                };
                addToHistory(downloadInfo);

                // Trigger download for this file only
                const directUrl = resolvedDownloadUrl || (finishedFilename ? `/download_by_filename/${encodeURIComponent(finishedFilename)}` : '');
                if (directUrl) {
                    setTimeout(() => {
                        const a = document.createElement('a');
                        a.href = directUrl;
                        a.download = finishedFilename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    }, 1000);
                } else {
                    showNotification('File saved locally but no download URL is available', 'warning', 4000);
                }
            }

            setTimeout(hideProgressBar, 5000);
        }

        // Progress bar management
        function showProgressBar(percent, text, thumbnail = '', title = '') {
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
            progressTitle.textContent = title || 'Downloading...';

            if (thumbnail) {
                progressThumb.innerHTML = `<img src="${thumbnail}" alt="Thumbnail">`;
            }

            progressBar.style.display = 'block';
        }

        function hideProgressBar() {
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = '';
            progressTitle.textContent = '';
            progressThumb.innerHTML = '🎬';
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div>${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</div>
                    <div>${message}</div>
                </div>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, duration);
        }

        // History management
        function addToHistory(downloadInfo) {
            try {
                const history = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
                history.unshift(downloadInfo);
                localStorage.setItem('downloadHistory', JSON.stringify(history.slice(0, 20)));
            } catch (e) {
                console.error('Error saving to history:', e);
            }
        }

        // Re-download function
        function redownload(originalUrl, quality, audioOnly, title) {
            // Set the URL in the input field
            urlInput.value = originalUrl;

            // Set current title for the download
            currentVideoTitle = title;

            // Start the download with the same settings
            startDownload(quality === 'Audio Only' ? 'best' : quality, originalUrl, audioOnly);

            // Hide the modal
            hideModal();

            showNotification('Starting re-download...', 'info', 3000);
        }

        function redownloadFromEntry(event, entry) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            if (!entry) {
                showNotification('Unable to locate history entry for re-download', 'error', 4000);
                return;
            }

            const originalUrl = decodeURIComponent(entry.dataset.originalUrl || '');
            const quality = decodeURIComponent(entry.dataset.downloadQuality || 'unknown');
            const audioOnly = entry.dataset.audioOnly === 'true';
            const title = decodeURIComponent(entry.dataset.title || '');

            if (!originalUrl) {
                showNotification('Original URL missing for this download', 'error', 4000);
                return;
            }

            redownload(originalUrl, quality, audioOnly, title || 'Downloading...');
        }

        async function openHistoryFile(event, entry) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            const targetEntry = entry || (event?.currentTarget ? event.currentTarget.closest('.history-entry') : null);
            if (!targetEntry) {
                showNotification('Unable to locate history entry', 'error', 4000);
                return;
            }

            const filePath = decodeURIComponent(targetEntry.dataset.filePath || '');
            const downloadUrl = decodeURIComponent(targetEntry.dataset.downloadUrl || '');
            const downloadId = decodeURIComponent(targetEntry.dataset.downloadId || '');
            const filename = decodeURIComponent(targetEntry.dataset.filename || '');
            const title = decodeURIComponent(targetEntry.dataset.title || '');

            let openedSuccessfully = false;
            let openErrorMessage = '';

            if (filePath) {
                try {
                    const response = await fetch('/api/open_file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: filePath })
                    });
                    const data = await response.json().catch(() => ({}));
                    if (response.ok) {
                        showNotification(`Opening "${title || filename || 'video'}" locally...`, 'success', 3000);
                        openedSuccessfully = true;
                    } else {
                        openErrorMessage = data.error || 'Unable to open file locally';
                    }
                } catch (err) {
                    openErrorMessage = err.message || 'Unexpected error opening file';
                }
            } else {
                openErrorMessage = 'Local file path not stored for this item';
            }

            if (openedSuccessfully) {
                return;
            }

            if (openErrorMessage) {
                showNotification(`${openErrorMessage}. Attempting download instead...`, 'warning', 4000);
            }

            const fallbackUrl = downloadUrl || (downloadId ? `/api/download/${downloadId}/file` : (filename ? `/download_by_filename/${encodeURIComponent(filename)}` : ''));
            if (fallbackUrl) {
                window.open(fallbackUrl, '_blank');
            } else {
                showNotification('No available fallback to download this file', 'error', 4000);
            }
        }

        function showHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
                const historyContent = document.getElementById('historyContent');

                if (history.length === 0) {
                    historyContent.innerHTML = '<p>No downloads yet</p>';
                } else {
                    historyContent.innerHTML = history.map(item => {
                        const encodedDownloadUrl = encodeURIComponent(item.downloadUrl || '');
                        const encodedDownloadId = encodeURIComponent(item.downloadId || '');
                        const encodedFilePath = encodeURIComponent(item.filePath || '');
                        const encodedFilename = encodeURIComponent(item.filename || '');
                        const encodedOriginalUrl = encodeURIComponent(item.originalUrl || '');
                        const encodedQuality = encodeURIComponent(item.downloadQuality || 'unknown');
                        const encodedTitle = encodeURIComponent(item.title || item.filename || 'Untitled Video');
                        const safeTitle = escapeHtml(item.title || item.filename || 'Untitled Video');
                        const qualityText = item.audioOnly ? 'Audio Only' : (item.downloadQuality || 'unknown');
                        const audioOnlyFlag = item.audioOnly ? 'true' : 'false';
                        return `
                        <div class="history-entry" data-download-url="${encodedDownloadUrl}" data-download-id="${encodedDownloadId}" data-file-path="${encodedFilePath}" data-filename="${encodedFilename}" data-original-url="${encodedOriginalUrl}" data-download-quality="${encodedQuality}" data-title="${encodedTitle}" data-audio-only="${audioOnlyFlag}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                            ${item.thumbnail ? `<img src="${item.thumbnail}" style="width: 60px; height: 34px; object-fit: cover; border-radius: 4px;">` : '<div style="width: 60px; height: 34px; background: var(--input-bg); border-radius: 4px;"></div>'}
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                                <button type="button" class="history-title" onclick="openHistoryFile(event, this.closest('.history-entry'))" style="all: unset; cursor: pointer; font-weight: 600; color: var(--accent);">
                                    ${safeTitle}
                                </button>
                                <div style="font-size: 0.9rem; color: var(--secondary);">${qualityText}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-direction: column;">
                                <button type="button" onclick="openHistoryFile(event, this.closest('.history-entry'))" style="background: var(--input-bg); color: var(--fg); padding: 6px 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 0.8rem; cursor: pointer;">Preview</button>
                                <button type="button" onclick="redownloadFromEntry(event, this.closest('.history-entry'))" style="background: var(--accent); color: white; padding: 6px 12px; border-radius: 12px; border: none; font-size: 0.8rem; cursor: pointer;">Download</button>
                            </div>
                        </div>`;
                    }).join('');
                }

                historyModal.style.display = 'flex';
                setTimeout(() => historyModal.classList.add('show'), 10);
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const clearBtn = document.getElementById('clearHistoryBtn');
            if (clearBtn) {
                clearBtn.onclick = function () {
                    if (confirm('Clear all download history?')) {
                        localStorage.removeItem('downloadHistory');
                        document.getElementById('historyContent').innerHTML = '<p>No downloads yet</p>';
                    }
                };
            }
        });

        function hideModal() {
            historyModal.classList.remove('show');
            setTimeout(() => historyModal.style.display = 'none', 300);
        }

        // Event listeners
        downloadBtn.addEventListener('click', showHistory);
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) hideModal();
        });

        // Show paste button only if clipboard API is available
        if (navigator.clipboard && navigator.clipboard.readText) {
            pasteBtn.style.display = 'flex';
        } else {
            pasteBtn.style.display = 'none';
        }

        // Auto-focus URL input
        urlInput.focus();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') {
                return;
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                fetchVideoInfo();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                showHistory();
            }

            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                urlInput.focus();
                urlInput.select();
            }

            if (e.key === 'Escape' && historyModal.classList.contains('show')) {
                hideModal();
            }
        });
    </script>

    <!-- Glassify inline SVG icons: apply gradient, blur and glossy edge -->
    <script>
        (function () {
            function applyGlassToIcons() {
                try {
                    // Apply glass effect only to the options icon
                    const selector = '.logo svg, .options svg';
                    const isLight = document.body.classList.contains('light');
                    const gradientId = isLight ? 'uvd-glassGradient-light' : 'uvd-glassGradient-dark';
                    const edgeId = isLight ? 'uvd-glassEdge-light' : 'uvd-glassEdge-dark';
                    const svgs = document.querySelectorAll(selector);
                    svgs.forEach((s) => {
                        if (!s || s.closest('#uvd-glass-defs')) return;
                        if (s.dataset.uvdGlassApplied) return;
                        s.dataset.uvdGlassApplied = '1';

                        // Apply subtle drop shadow
                        s.style.filter = 'drop-shadow(0 6px 18px rgba(0,0,0,0.32))';
                        s.style.transition = 'transform 0.18s ease, opacity 0.18s ease';

                        // Ensure filter reference exists on the svg for a gentle blur effect
                        try { s.setAttribute('filter', 'url(#uvd-glassBlur)'); } catch (e) { }

                        const children = s.querySelectorAll('path, circle, rect, polyline, line, polygon, ellipse');
                        children.forEach((el) => {
                            try {
                                const fill = el.getAttribute('fill');
                                const stroke = el.getAttribute('stroke');

                                // Prefer to keep explicit 'none' values
                                const gradientUrl = `url(#${gradientId})`;
                                if (fill && fill !== 'none') {
                                    el.setAttribute('fill', gradientUrl);
                                } else if (stroke && stroke !== 'none') {
                                    el.setAttribute('stroke', gradientUrl);
                                } else {
                                    // Default for line-only icons
                                    el.setAttribute('stroke', gradientUrl);
                                }

                                // Add subtle blend and smoothing
                                el.style.mixBlendMode = 'screen';
                                el.style.transition = 'stroke 0.2s ease, fill 0.2s ease';

                                // Add a glossy highlight by appending a cloned overlay with the edge gradient
                                const overlay = el.cloneNode(true);
                                overlay.setAttribute('fill', 'none');
                                overlay.setAttribute('stroke', `url(#${edgeId})`);
                                overlay.setAttribute('opacity', '0.85');
                                const sw = parseFloat(el.getAttribute('stroke-width') || '1');
                                overlay.setAttribute('stroke-width', (sw + 0.6).toString());
                                overlay.style.pointerEvents = 'none';
                                s.appendChild(overlay);

                            } catch (err) {
                                // ignore per-element errors
                                console.debug('glassify element error', err);
                            }
                        });
                    });
                } catch (err) {
                    console.error('applyGlassToIcons failed', err);
                }
            }

            // Run on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', applyGlassToIcons);
            } else {
                setTimeout(applyGlassToIcons, 20);
            }

            // Re-apply after theme toggles to ensure styles stay consistent
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => setTimeout(applyGlassToIcons, 120));
            }
        })();
    </script>

</body>

</html>